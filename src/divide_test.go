package main

import (
	"fmt"
	"testing"
)

func divide(b *board, depth int) map[string]int {
	results := make(map[string]int)

	moves := b.generateMoves(b.sideToMove)

	for _, m := range moves {
		cb := b.copyBoard()
		cb.makeMove(m)
		var nodes int
		if depth > 1 {
			nodes = perft(&cb, depth-1)
		} else {
			nodes = 1
		}
		coord := fmt.Sprint(coordBySquareIndex(m.origin), coordBySquareIndex(m.target))
		results[coord] = nodes
	}

	return results
}

func TestDivide(t *testing.T) {
	tests := []struct {
		fen             string
		depth           int
		expectedMoves   int
		expectedResults map[string]int
	}{
		{STARTING_FEN, 3, 20,
			map[string]int{
				"b1a3": 400,
				"b1c3": 440,
				"g1f3": 440,
				"g1h3": 400,
				"a2a4": 420,
				"a2a3": 380,
				"b2b4": 421,
				"b2b3": 420,
				"c2c4": 441,
				"c2c3": 420,
				"d2d4": 560,
				"d2d3": 539,
				"e2e4": 600,
				"e2e3": 599,
				"f2f4": 401,
				"f2f3": 380,
				"g2g4": 421,
				"g2g3": 420,
				"h2h4": 420,
				"h2h3": 380,
			},
		},
		{"rnbqkbnr/pppppppp/8/8/8/2N5/PPPPPPPP/R1BQKBNR b KQkq - 1 1", 2, 20,
			map[string]int{
				"a7a6": 22,
				"a7a5": 22,
				"b7b6": 22,
				"b7b5": 22,
				"c7c6": 22,
				"c7c5": 22,
				"d7d6": 22,
				"d7d5": 22,
				"e7e6": 22,
				"e7e5": 22,
				"f7f6": 22,
				"f7f5": 22,
				"g7g6": 22,
				"g7g5": 22,
				"h7h6": 22,
				"h7h5": 22,
				"b8a6": 22,
				"b8c6": 22,
				"g8f6": 22,
				"g8h6": 22,
			},
		},
		{"rnbqkbnr/1ppppppp/p7/8/8/2N5/PPPPPPPP/R1BQKBNR w KQkq - 0 2", 1, 22,
			map[string]int{
				"a2a3": 1,
				"a2a4": 1,
				"b2b3": 1,
				"b2b4": 1,
				"d2d3": 1,
				"d2d4": 1,
				"e2e3": 1,
				"e2e4": 1,
				"f2f3": 1,
				"f2f4": 1,
				"g2g3": 1,
				"g2g4": 1,
				"h2h3": 1,
				"h2h4": 1,
				"c3b1": 1,
				"c3d5": 1,
				"c3e4": 1,
				"c3a4": 1,
				"c3b5": 1,
				"a1b1": 1,
				"g1h3": 1,
				"g1f3": 1,
			},
		},
		{STARTING_FEN, 4, 20,
			map[string]int{
				"a2a3": 8457,
				"a2a4": 9329,
				"b2b3": 9345,
				"b2b4": 9332,
				"c2c3": 9272,
				"c2c4": 9744,
				"d2d3": 11959,
				"d2d4": 12435,
				"e2e3": 13134,
				"e2e4": 13160,
				"f2f3": 8457,
				"f2f4": 8929,
				"g2g3": 9345,
				"g2g4": 9328,
				"h2h3": 8457,
				"h2h4": 9329,
				"b1c3": 9755,
				"b1a3": 8885,
				"g1h3": 8881,
				"g1f3": 9748,
			},
		},
		{"rnbqkbnr/pppppppp/8/8/P7/8/1PPPPPPP/RNBQKBNR b KQkq - 0 1", 3, 20,
			map[string]int{
				"a7a6": 398,
				"a7a5": 401,
				"b7b6": 441,
				"b7b5": 480,
				"c7c6": 440,
				"c7c5": 462,
				"d7d6": 565,
				"d7d5": 587,
				"e7e6": 628,
				"e7e5": 629,
				"f7f6": 398,
				"f7f5": 420,
				"g7g6": 440,
				"g7g5": 441,
				"h7h6": 398,
				"h7h5": 440,
				"b8a6": 420,
				"b8c6": 461,
				"g8f6": 461,
				"g8h6": 419,
			},
		},
		{"rnbqkbnr/1ppppppp/p7/8/P7/8/1PPPPPPP/RNBQKBNR w KQkq - 0 2", 2, 21,
			map[string]int{
				"a4a5": 18,
				"b2b3": 19,
				"b2b4": 19,
				"c2c3": 19,
				"c2c4": 19,
				"d2d3": 19,
				"d2d4": 19,
				"e2e3": 19,
				"e2e4": 19,
				"f2f3": 19,
				"f2f4": 19,
				"g2g3": 19,
				"g2g4": 19,
				"h2h3": 19,
				"h2h4": 19,
				"a1a2": 19,
				"a1a3": 19,
				"b1c3": 19,
				"b1a3": 19,
				"g1h3": 19,
				"g1f3": 19,
			},
		},
		{"rnbqkbnr/1ppppppp/p7/8/PP6/8/2PPPPPP/RNBQKBNR b KQkq - 0 2", 1, 19,
			map[string]int{
				"b7b6": 1,
				"b7b5": 1,
				"c7c6": 1,
				"c7c5": 1,
				"d7d6": 1,
				"d7d5": 1,
				"e7e6": 1,
				"e7e5": 1,
				"f7f6": 1,
				"f7f5": 1,
				"g7g6": 1,
				"g7g5": 1,
				"h7h6": 1,
				"h7h5": 1,
				"a6a5": 1,
				"a8a7": 1,
				"b8c6": 1,
				"g8f6": 1,
				"g8h6": 1,
			},
		},
		{"rnbqkbnr/pppppppp/8/8/8/5N2/PPPPPPPP/RNBQKB1R b KQkq - 1 1", 3, 20,
			map[string]int{
				"a7a6": 416,
				"a7a5": 460,
				"b7b6": 460,
				"b7b5": 461,
				"c7c6": 460,
				"c7c5": 484,
				"d7d6": 591,
				"d7d5": 612,
				"e7e6": 656,
				"e7e5": 657,
				"f7f6": 416,
				"f7f5": 438,
				"g7g6": 460,
				"g7g5": 461,
				"h7h6": 417,
				"h7h5": 459,
				"b8a6": 438,
				"b8c6": 482,
				"g8f6": 482,
				"g8h6": 438,
			},
		},
		{"rnbqkbnr/pppppp1p/8/6p1/8/5N2/PPPPPPPP/RNBQKB1R w KQkq - 0 2", 2, 22,
			map[string]int{
				"a2a3": 21,
				"a2a4": 21,
				"b2b3": 21,
				"b2b4": 21,
				"c2c3": 21,
				"c2c4": 21,
				"d2d3": 21,
				"d2d4": 21,
				"e2e3": 21,
				"e2e4": 21,
				"g2g3": 21,
				"g2g4": 20,
				"h2h3": 21,
				"h2h4": 22,
				"f3g5": 20,
				"f3h4": 22,
				"f3d4": 21,
				"f3g1": 21,
				"f3e5": 20,
				"b1c3": 21,
				"b1a3": 21,
				"h1g1": 21,
			},
		},
		{"rnbqkbnr/pppppp1p/8/6N1/8/8/PPPPPPPP/RNBQKB1R b KQkq - 0 2", 1, 20,
			map[string]int{
				"a7a6": 1,
				"a7a5": 1,
				"b7b6": 1,
				"b7b5": 1,
				"c7c6": 1,
				"c7c5": 1,
				"d7d6": 1,
				"d7d5": 1,
				"e7e6": 1,
				"e7e5": 1,
				"f7f6": 1,
				"f7f5": 1,
				"h7h6": 1,
				"h7h5": 1,
				"b8a6": 1,
				"b8c6": 1,
				"f8g7": 1,
				"f8h6": 1,
				"g8f6": 1,
				"g8h6": 1,
			},
		},
		{STARTING_FEN, 5, 20,
			map[string]int{
				"a2a3": 181046,
				"a2a4": 217832,
				"b2b3": 215255,
				"b2b4": 216145,
				"c2c3": 222861,
				"c2c4": 240082,
				"d2d3": 328511,
				"d2d4": 361790,
				"e2e3": 402988,
				"e2e4": 405385,
				"f2f3": 178889,
				"f2f4": 198473,
				"g2g3": 217210,
				"g2g4": 214048,
				"h2h3": 181044,
				"h2h4": 218829,
				"b1c3": 234656,
				"b1a3": 198572,
				"g1h3": 198502,
				"g1f3": 233491,
			},
		},
		{"rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq - 0 1", 4, 20,
			map[string]int{
				"a7a6": 17532,
				"a7a5": 19314,
				"b7b6": 19225,
				"b7b5": 18241,
				"c7c6": 19256,
				"c7c5": 20035,
				"d7d6": 24086,
				"d7d5": 27226,
				"e7e6": 27272,
				"e7e5": 24825,
				"f7f6": 16782,
				"f7f5": 19471,
				"g7g6": 19354,
				"g7g5": 19080,
				"h7h6": 17402,
				"h7h5": 19324,
				"b8a6": 18295,
				"b8c6": 20144,
				"g8f6": 20190,
				"g8h6": 18331,
			},
		},
		{"rnbqkbnr/pp1ppppp/8/2p5/4P3/8/PPPP1PPP/RNBQKBNR w KQkq - 0 2", 3, 30,
			map[string]int{
				"e1e2": 527,
				"e4e5": 628,
				"a2a3": 633,
				"a2a4": 676,
				"b2b3": 678,
				"b2b4": 731,
				"c2c3": 679,
				"c2c4": 589,
				"d2d3": 700,
				"d2d4": 859,
				"f2f3": 567,
				"f2f4": 656,
				"g2g3": 677,
				"g2g4": 634,
				"h2h3": 633,
				"h2h4": 677,
				"b1c3": 702,
				"b1a3": 655,
				"d1e2": 633,
				"d1f3": 849,
				"d1g4": 871,
				"d1h5": 784,
				"f1e2": 611,
				"f1d3": 635,
				"f1c4": 711,
				"f1b5": 639,
				"f1a6": 653,
				"g1h3": 633,
				"g1e2": 504,
				"g1f3": 611,
			},
		},
		{"rnbqkbnr/pp1ppppp/8/2p1P3/8/8/PPPP1PPP/RNBQKBNR b KQkq - 0 2", 2, 21,
			map[string]int{
				"a7a6": 30,
				"a7a5": 30,
				"b7b6": 30,
				"b7b5": 29,
				"d7d6": 31,
				"d7d5": 31,
				"e7e6": 29,
				"f7f6": 31,
				"f7f5": 31,
				"g7g6": 30,
				"g7g5": 30,
				"h7h6": 30,
				"h7h5": 30,
				"c5c4": 27,
				"b8a6": 30,
				"b8c6": 30,
				"d8c7": 30,
				"d8b6": 30,
				"d8a5": 28,
				"g8f6": 31,
				"g8h6": 30,
			},
		},
		{"rnbqkbnr/pp1pp1pp/8/2p1Pp2/8/8/PPPP1PPP/RNBQKBNR w KQkq f6 0 3", 1, 31,
			map[string]int{
				"e1e2": 1,
				"e5e6": 1,
				"e5f6": 1,
				"a2a3": 1,
				"a2a4": 1,
				"b2b3": 1,
				"b2b4": 1,
				"c2c3": 1,
				"c2c4": 1,
				"d2d3": 1,
				"d2d4": 1,
				"f2f3": 1,
				"f2f4": 1,
				"g2g3": 1,
				"g2g4": 1,
				"h2h3": 1,
				"h2h4": 1,
				"b1c3": 1,
				"b1a3": 1,
				"d1e2": 1,
				"d1f3": 1,
				"d1g4": 1,
				"d1h5": 1,
				"f1e2": 1,
				"f1d3": 1,
				"f1c4": 1,
				"f1b5": 1,
				"f1a6": 1,
				"g1h3": 1,
				"g1e2": 1,
				"g1f3": 1,
			},
		},
		// {STARTING_FEN, 6, 20,
		// 	map[string]int{
		// 		"a2a3": 4463267,
		// 		"a2a4": 5363555,
		// 		"b2b3": 5310358,
		// 		"b2b4": 5293555,
		// 		"c2c3": 5417640,
		// 		"c2c4": 5866666,
		// 		"d2d3": 8073082,
		// 		"d2d4": 8879566,
		// 		"e2e3": 9726018,
		// 		"e2e4": 9771632,
		// 		"f2f3": 4404141,
		// 		"f2f4": 4890429,
		// 		"g2g3": 5346260,
		// 		"g2g4": 5239875,
		// 		"h2h3": 4463070,
		// 		"h2h4": 5385554,
		// 		"b1c3": 5708064,
		// 		"b1a3": 4856835,
		// 		"g1h3": 4877234,
		// 		"g1f3": 5723523,
		// 	},
		// },
	}
	seedKeys(181818)
	for _, tt := range tests {
		b, err := newBoard(tt.fen)
		if err != nil {
			t.Error(err)
		}
		actualResults := divide(b, tt.depth)
		if len(actualResults) != tt.expectedMoves {
			t.Errorf("expected moves %v != %v", tt.expectedMoves, len(actualResults))
		}
		for coord, expectedNodes := range tt.expectedResults {
			actualNodes, ok := actualResults[coord]
			if !ok {
				t.Errorf("coord %v not found", coord)
			}
			if actualNodes != expectedNodes {
				t.Errorf("coord %v nodes: %v != %v", coord, actualNodes, expectedNodes)
			}
		}
		for coord := range actualResults {
			_, ok := tt.expectedResults[coord]
			if !ok {
				t.Errorf("coord %v found but is not a valid move", coord)
			}
		}
	}
}
